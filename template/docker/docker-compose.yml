services:
  __APP_NAME__-deps:
    image: __APP_NAME__:deps
    build:
      context: ..
      dockerfile: docker/Dockerfile.deps
      args:
        BASE_IMAGE: ${BASE_IMAGE:-python:3.12-slim}

  __APP_NAME__-web:
    container_name: __APP_NAME___web
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        DEPS_IMAGE: __APP_NAME__:deps
    working_dir: /app
    env_file:
      - ../.env
    environment:
      - PYTHONPATH=/app
      - LOG_DIR=/app/logs
      - MYSQL_URL=${MYSQL_URL:-__MYSQL_URL__}
      - REDIS_URL=${REDIS_URL:-__REDIS_URL__}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL:-__CELERY_BROKER_URL__}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND:-__CELERY_RESULT_BACKEND__}
    ports:
      - "8000:8000"
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    volumes:
      - ..:/app
      - ../logs:/app/logs
    # attach to default external network

  __APP_NAME__-worker:
    container_name: __APP_NAME___worker
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        DEPS_IMAGE: __APP_NAME__:deps
    working_dir: /app
    env_file:
      - ../.env
    environment:
      - PYTHONPATH=/app
      - LOG_DIR=/app/logs
      - MYSQL_URL=${MYSQL_URL:-__MYSQL_URL__}
      - REDIS_URL=${REDIS_URL:-__REDIS_URL__}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL:-__CELERY_BROKER_URL__}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND:-__CELERY_RESULT_BACKEND__}
    command: ["celery", "-A", "app.tasks.celery:celery_app", "worker", "--loglevel=INFO"]
    volumes:
      - ..:/app
      - ../logs:/app/logs
    # attach to default external network
networks:
  default:
    external: true
    name: ${SHARED_NETWORK_NAME:-docker_default}
